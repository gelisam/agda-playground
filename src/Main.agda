module Main where

open import Data.List
open import Data.Nat using (ℕ; zero; suc)


--------------------
-- Standard stuff --
--------------------

_$_ : {A B : Set} → (A → B) → A → B
_$_ f x = f x
infixr -1 _$_

data Elem {A : Set} : A → List A → Set where
  Here : ∀ {x xs} → Elem x (x ∷ xs)
  There : ∀ {x y xs} → Elem x xs → Elem x (y ∷ xs)


-----------
-- Types --
-----------

-- Types for the phase 0 code, including user-written code and code generated by
-- the macros.
data Ty : Set where
  NatTy : Ty
  _:->:_ : Ty → Ty → Ty

-- Types for the implementation of a macro. In this simplified setting, macro
-- definitions cannot themselves contain macro calls.
data MacroTy : Set where
  NatTy : MacroTy
  _:->:_ : MacroTy → MacroTy → MacroTy
  DiaTy : Ty → MacroTy

infixr 4 _:->:_


-----------
-- Terms --
-----------

mutual
  -- * mu contains the phase 1 macro definitions.
  -- * gamma contains the phase 0 variables.
  data Term (mu : List MacroTy) (gamma : List Ty) : Ty → Set where
    Var
      : ∀ {ty}
      → Elem ty gamma
      → Term mu gamma ty
    Zero
      : Term mu gamma NatTy
    Succ
      : Term mu gamma NatTy
      → Term mu gamma NatTy
    FoldNat
      : ∀ {ty}
      → Term mu gamma ty
      → Term mu gamma (ty :->: ty)
      → Term mu gamma NatTy
      → Term mu gamma ty
    App
      : ∀ {ty1 ty2}
      → Term mu gamma (ty1 :->: ty2)
      → Term mu gamma ty1
      → Term mu gamma ty2
    Lam
      : ∀ {ty1 ty2}
      → Term mu (gamma ++ [ ty1 ]) ty2
      → Term mu gamma (ty1 :->: ty2)
    Let
      : ∀ {ty1 ty2}
      → Term mu gamma ty1
      → Term mu (gamma ++ [ ty1 ]) ty2
      → Term mu gamma ty2
    LetMacro
      : ∀ {ty1 ty2}
      → MacroTerm mu gamma ty1
      → Term (mu ++ [ ty1 ]) gamma ty2
      → Term mu gamma ty2
    MacroCall
      : ∀ {ty}
      → MacroTerm mu gamma (DiaTy ty)
      → Term mu gamma ty

  data MacroTerm (mu : List MacroTy) (gamma : List Ty) : MacroTy → Set where
    Var
      : ∀ {ty}
      → Elem ty mu
      → MacroTerm mu gamma ty
    Zero
      : MacroTerm mu gamma NatTy
    Succ
      : MacroTerm mu gamma NatTy
      → MacroTerm mu gamma NatTy
    FoldNat
      : ∀ {ty}
      → MacroTerm mu gamma ty
      → MacroTerm mu gamma (ty :->: ty)
      → MacroTerm mu gamma NatTy
      → MacroTerm mu gamma ty
    App
      : ∀ {ty1 ty2}
      → MacroTerm mu gamma (ty1 :->: ty2)
      → MacroTerm mu gamma ty1
      → MacroTerm mu gamma ty2
    Lam
      : ∀ {ty1 ty2}
      → MacroTerm (mu ++ [ ty1 ]) gamma ty2
      → MacroTerm mu gamma (ty1 :->: ty2)
    Let
      : ∀ {ty1 ty2}
      → MacroTerm mu gamma ty1
      → MacroTerm (mu ++ [ ty1 ]) gamma ty2
      → MacroTerm mu gamma ty2
    Quote
      : ∀ {ty}
      → Term mu gamma ty
      → MacroTerm mu gamma (DiaTy ty)
    LetQuote
      : ∀ {ty1 ty2}
      → MacroTerm mu gamma (DiaTy ty1)
      → MacroTerm mu (gamma ++ [ ty1 ]) ty2
      → MacroTerm mu gamma ty2


---------------
-- Weakening --
---------------

module _ {A : Set} where
  data _⊆_ : List A → List A → Set where
    []
      : [] ⊆ []
    yes∷_
      : ∀ {x xs xys}
      → xs ⊆ xys
      → x ∷ xs ⊆ x ∷ xys
    no∷_
      : ∀ {y xs xys}
      → xs ⊆ xys
      → xs ⊆ y ∷ xys
  infix 4 _⊆_

  emptySubset
    : ∀ {xys : List A}
    → [] ⊆ xys
  emptySubset {[]}
    = []
  emptySubset {y ∷ xys}
    = no∷ (emptySubset {xys})

  _++[yes]
    : ∀ {x : A} {xs xys}
    → xs ⊆ xys
    → (xs ++ [ x ]) ⊆ (xys ++ [ x ])
  [] ++[yes]
    = yes∷ []
  (yes∷ subset) ++[yes]
    = yes∷ (subset ++[yes])
  (no∷ subset) ++[yes]
    = no∷ (subset ++[yes])

  weakenElem
    : ∀ {x : A} {xs xys}
    → xs ⊆ xys
    → Elem x xs
    → Elem x xys
  weakenElem (yes∷_ _) Here
    = Here
  weakenElem (yes∷ xs) (There i)
    = There (weakenElem xs i)
  weakenElem (no∷ xs) i
    = There (weakenElem xs i)

mutual
  weakenTerm
    : ∀ {mu mu' gamma gamma' ty}
    → mu ⊆ mu'
    → gamma ⊆ gamma'
    → Term mu gamma ty
    → Term mu' gamma' ty
  weakenTerm _ gammaSubset (Var i)
    = Var (weakenElem gammaSubset i)
  weakenTerm _ _ Zero
    = Zero
  weakenTerm muSubset gammaSubset (Succ e)
    = Succ (weakenTerm muSubset gammaSubset e)
  weakenTerm muSubset gammaSubset (FoldNat ez es en)
    = FoldNat
        (weakenTerm muSubset gammaSubset ez)
        (weakenTerm muSubset gammaSubset es)
        (weakenTerm muSubset gammaSubset en)
  weakenTerm muSubset gammaSubset (App f e)
    = App
        (weakenTerm muSubset gammaSubset f)
        (weakenTerm muSubset gammaSubset e)
  weakenTerm muSubset gammaSubset (Lam e)
    = Lam (weakenTerm muSubset (gammaSubset ++[yes]) e)
  weakenTerm muSubset gammaSubset (Let e1 e2)
    = Let
        (weakenTerm muSubset gammaSubset e1)
        (weakenTerm muSubset (gammaSubset ++[yes]) e2)
  weakenTerm muSubset gammaSubset (LetMacro e1 e2)
    = LetMacro
        (weakenMacroTerm muSubset gammaSubset e1)
        (weakenTerm (muSubset ++[yes]) gammaSubset e2)
  weakenTerm muSubset gammaSubset (MacroCall e)
    = MacroCall (weakenMacroTerm muSubset gammaSubset e)

  weakenMacroTerm
    : ∀ {mu mu' gamma gamma' ty}
    → mu ⊆ mu'
    → gamma ⊆ gamma'
    → MacroTerm mu gamma ty
    → MacroTerm mu' gamma' ty
  weakenMacroTerm muSubset _ (Var i)
    = Var (weakenElem muSubset i)
  weakenMacroTerm _ _ Zero
    = Zero
  weakenMacroTerm muSubset gammaSubset (Succ e)
    = Succ (weakenMacroTerm muSubset gammaSubset e)
  weakenMacroTerm muSubset gammaSubset (FoldNat ez es en)
    = FoldNat
        (weakenMacroTerm muSubset gammaSubset ez)
        (weakenMacroTerm muSubset gammaSubset es)
        (weakenMacroTerm muSubset gammaSubset en)
  weakenMacroTerm muSubset gammaSubset (App f e)
    = App
        (weakenMacroTerm muSubset gammaSubset f)
        (weakenMacroTerm muSubset gammaSubset e)
  weakenMacroTerm muSubset gammaSubset (Lam e)
    = Lam (weakenMacroTerm (muSubset ++[yes]) gammaSubset e)
  weakenMacroTerm muSubset gammaSubset (Let e1 e2)
    = Let
        (weakenMacroTerm muSubset gammaSubset e1)
        (weakenMacroTerm (muSubset ++[yes]) gammaSubset e2)
  weakenMacroTerm muSubset gammaSubset (Quote e)
    = Quote (weakenTerm muSubset gammaSubset e)
  weakenMacroTerm muSubset gammaSubset (LetQuote e1 e2)
    = LetQuote
        (weakenMacroTerm muSubset gammaSubset e1)
        (weakenMacroTerm muSubset (gammaSubset ++[yes]) e2)

closedTerm
  : ∀ {mu gamma ty}
  → Term [] [] ty
  → Term mu gamma ty
closedTerm
  = weakenTerm emptySubset emptySubset

closedMacroTerm
  : ∀ {mu gamma ty}
  → MacroTerm [] [] ty
  → MacroTerm mu gamma ty
closedMacroTerm
  = weakenMacroTerm emptySubset emptySubset

--------------
-- Examples --
--------------

natLit
  : ∀ {mu gamma}
  → ℕ
  → Term mu gamma NatTy
natLit zero
  = Zero
natLit (suc n)
  = Succ (natLit n)

macroNatLit
  : ∀ {mu gamma}
  → ℕ
  → MacroTerm mu gamma NatTy
macroNatLit zero
  = Zero
macroNatLit (suc n)
  = Succ (macroNatLit n)

add
  : ∀ {mu gamma}
  → Term mu gamma (NatTy :->: NatTy :->: NatTy)
add
  = closedTerm
  $ Lam {-x-}
  $ Lam {-y-}
  $ FoldNat
      (Var {-y-} (There Here))
      ( Lam {- x-1 + y -}
      $ Succ (Var {- x-1 + y -} (There (There Here)))
      )
      (Var {-x-} Here)

macroAdd
  : ∀ {mu gamma}
  → MacroTerm mu gamma (NatTy :->: NatTy :->: NatTy)
macroAdd
  = closedMacroTerm
  $ Lam {-x-}
  $ Lam {-y-}
  $ FoldNat
      (Var {-y-} (There Here))
      ( Lam {- x-1 + y -}
      $ Succ (Var {- x-1 + y -} (There (There Here)))
      )
      (Var {-x-} Here)

times
  : ∀ {mu gamma}
  → Term mu gamma (NatTy :->: NatTy :->: NatTy)
times
  = closedTerm
  $ Lam {-x-}
  $ Lam {-y-}
  $ FoldNat
      Zero
      ( Lam {- (x-1) * y -}
      $ App
          (App
            add
            (Var {- (x-1) * y -} (There (There Here))))
          (Var {-y-} (There Here))
      )
      (Var {-x-} Here)

macroTimes
  : ∀ {mu gamma}
  → MacroTerm mu gamma (NatTy :->: NatTy :->: NatTy)
macroTimes
  = closedMacroTerm
  $ Lam {-x-}
  $ Lam {-y-}
  $ FoldNat
      Zero
      ( Lam {- (x-1) * y -}
      $ App
          (App
            macroAdd
            (Var {- (x-1) * y -} (There (There Here))))
          (Var {-y-} (There Here))
      )
      (Var {-x-} Here)

power : MacroTerm [] [] (NatTy :->: DiaTy NatTy :->: DiaTy NatTy)
power
  = Lam {-n-}
  $ Lam {-diaX-}
  $ LetQuote {-x-} (Var {-diaX-} (There Here))
  $ FoldNat
      (Quote (natLit 1))
      ( Lam {- power (n-1) diaX -}
      $ LetQuote {- power (n-1) x -} (Var {- power (n-1) diaX -} (There (There Here)))
      $ Quote
      $ App
          (App
            times
            (Var {- power (n-1) x -} (There Here)))
          (Var {-x-} Here)
      )
      (Var {-n-} Here)

square : Term [] [] (NatTy :->: NatTy)
square
  = LetMacro {-power-} power
  $ Lam {-x-}
  $ MacroCall
  $ App
      (App
        (Var {-power-} Here)
        (macroNatLit 2))
      (Quote (Var {-x-} Here))